#!/sbin/sh

export ZIPARG2="$2"

my_print() {
	printf '%s\n' "ui_print $1" >> "/proc/self/fd/$ZIPARG2"
}

getVolumeKey() {
    my_print " - Volume Up [+] to $1"
    my_print " - Volume Down [-] to $2"
    keyInfo=true
    while "$keyInfo"; do
        keyInfo="$(getevent -qlc 1 | grep KEY_VOLUME)"
        if [ "$keyInfo" = "" ]; then
            continue
        else
            isUpKey=$(echo "$keyInfo" | grep KEY_VOLUMEUP)
            [ "$isUpKey" != "" ] && return 0 || return 1
        fi
    done
}

extract() {
	mountpoint -q /system || mount /system

	active_slot="$(getprop ro.boot.slot_suffix)"
	system_date="$(date -u -d @$(grep ro.build.date.utc /system/build.prop | cut -d '=' -f2) +'%d_%m_%Y')"

	my_print " "
	my_print "Extracting active slot init_boot${active_slot}..."

	dd if=/dev/block/bootdevice/by-name/init_boot"${active_slot}" of=/sdcard/Download/init_boot_"${system_date}".img || {
		my_print "Failed to extract init_boot${active_slot}. Exiting..."
		exit 1
	}
	sync

	my_print " "

	my_print "Extracted init_boot${active_slot}.img into:" 
	my_print "/sdcard/Download/init_boot_"${system_date}".img"

	my_print " "

	my_print "Ready for patching in KernelSU app"

}

installer () {
	active_slot="$(getprop ro.boot.slot_suffix)"

	mkdir -p /tmp/init_boot
	unzip -o "$3" -d /tmp/init_boot

	my_print " "

	img_count="$(ls /tmp/init_boot/*.img 2>/dev/null | wc -l)"
	if [ "$img_count" -eq 0 ]; then
		my_print "No .img file found within zip, aborting..."
		exit 1
	elif [ "$img_count" -gt 1 ]; then
		my_print "More than one .img file found within zip, aborting..."
		exit 1
	fi

	img_path="$(ls /tmp/init_boot/*.img)"
	img_name="${img_path##*/}"

	my_print "Flashing ${img_name} to active slot: ${active_slot}..."

	dd if="${img_path}" of=/dev/block/bootdevice/by-name/init_boot"${active_slot}" || {
		my_print "Failed to flash init_boot. Exiting..."
		exit 1
	}
	sync

	rm -rf /tmp/init_boot

	my_print "Done."
}

my_print " "
my_print "Extract init_boot OR Flash init_boot from within zip?"

if getVolumeKey "Extract" "Flash"; then
	extract
else
	installer
fi

my_print " "

exit 0
