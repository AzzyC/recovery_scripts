#!/sbin/sh

export ZIPARG2="$2"

my_print() {
	printf '%s\n' "ui_print $1" >> "/proc/self/fd/$ZIPARG2"
}

getVolumeKey() {
	my_print "  Volume Up [+] : $1"
	my_print "  Volume Down [-] : $2"

	while true; do
		keyInfo="$(getevent -qlc 1 | grep 'KEY_VOLUME.*DOWN')"
		case "$keyInfo" in
		    *KEY_VOLUMEUP*) return 0 ;;
		    *KEY_VOLUMEDOWN*) return 1 ;;
		esac
	done
}

wipe_no_storage () {

	mountpoint -q /data || mount /data
	mountpoint -q /metadata || mount /metadata

	before_data="$(du -ms /data | cut -f1)"
	before_meta="$(du -s /metadata | cut -f1)"

	my_print " "

	my_print "Wiping /data without /data/media..."

	find /data -mindepth 1 -maxdepth 1 \
    ! -name media \
    ! -name recovery \
    -exec rm -rf {} +

	my_print "Done."

	my_print "Formatting /metadata using mke2fs..."
	umount /metadata
	mke2fs -t ext4 -O ^has_journal -m 0 /dev/block/bootdevice/by-name/metadata
	mountpoint -q /metadata || mount /metadata
	my_print "Done."

	after_data="$(du -ms /data | cut -f1)"
	after_meta="$(du -s /metadata | cut -f1)"

	my_print " "

	my_print "/data: ${before_data}mb -> ${after_data}mb"
	my_print "/metadata: ${before_meta}b -> ${after_meta}b"

	my_print " "

	my_print "Full Data Wipe complete. You can now flash your ROM!"

}

dirty_flash_wipe () {

	mountpoint -q /data || mount /data
	mountpoint -q /metadata || mount /metadata

	before_dalvik="$(du -s /data/dalvik-cache | cut -f1)"
	before_resource="$(du -s /data/resource-cache | cut -f1)"
	before_cache="$(du -s /data/cache | cut -f1)"
	before_meta="$(du -s /metadata | cut -f1)"

	my_print " "

	for cache in /data/dalvik-cache /data/resource-cache /data/cache; do
		my_print "Wiping $cache..."
		rm -rf "$cache"
	done
	my_print "Done."

	my_print "Formatting /metadata using mke2fs..."
	umount /metadata
	mke2fs -t ext4 -O ^has_journal -m 0 /dev/block/bootdevice/by-name/metadata
	mountpoint -q /metadata || mount /metadata
	my_print "Done."

	[ ! -d /data/dalvik-cache ] && after_dalvik='0'
	[ ! -d /data/resource-cache ] && after_resource='0'
	[ ! -d /data/cache ] && after_cache='0'
	after_meta="$(du -s /metadata | cut -f1)"

	my_print " "

	my_print "dalvik-cache: ${before_dalvik}b -> ${after_dalvik}b"
	my_print "resource-cache: ${before_resource}b -> ${after_resource}b"
	my_print "cache: ${before_cache}b -> ${after_cache}b"
	my_print "/metadata: ${before_meta}b -> ${after_meta}b"

	my_print " "

	my_print "Dirty-Flash Wipe complete."

}

my_print " "
my_print "Select wipe mode:"
my_print " "

if getVolumeKey "Full Wipe (/data, keep media)" "Dirty-Flash Wipe (caches only)"; then

	my_print " "
	my_print ">> Volume Up detected"
	my_print " "

	my_print "Confirm Full Wipe (excluding /data/media):"
	my_print " "
	if getVolumeKey "Yes (Wipe)" "No (Cancel)"; then
		my_print " "
		my_print ">> Volume Up detected"
	 	wipe_no_storage
	 else
	 	my_print " "
	 	my_print ">> Volume Down detected"
	 	my_print " "
	 	my_print "Wipe cancelled, aborted by user."
	 	my_print " "
	 	exit 0
	 fi

else
	my_print " "
	my_print ">> Volume Down detected"
	dirty_flash_wipe
fi

my_print " "
sync

exit 0
